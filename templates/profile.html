{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center animate-fade-in-up mt-2">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4 p-md-5 text-center">
                <h3 class="fw-bold mb-4">Immutable Identity Verification</h3>

                <!-- Current Photo or Placeholder -->
                <div class="mb-4" id="current-photo-section">
                    {% if user_data and user_data.get('avatar') %}
                    <img src="{{ user_data.get('avatar') if user_data.get('avatar', '').startswith('http') else '/static/uploads/' + user_data.get('avatar', '') }}"
                        alt="Current Profile" class="rounded-circle border border-3 border-primary shadow-sm"
                        style="width: 150px; height: 150px; object-fit: contain; background-color: #f0f0f0;">
                    <p class="mt-3 small" style="color: var(--bs-secondary-color);">
                        <i class="bi bi-check-circle-fill" style="color: #22c55e;"></i> This
                        verified photo will be permanently cryptographically signed to all future documents.
                    </p>
                    {% else %}
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto border border-2 text-muted"
                        style="width: 150px; height: 150px; border-style: dashed !important;">
                        <i class="bi bi-person-fill" style="font-size: 5rem;"></i>
                    </div>
                    <p class="mt-3 small fw-semibold" style="color: var(--bs-secondary-color);">
                        <i class="bi bi-info-circle-fill" style="color: #195de6;"></i>
                        No identity photo set. Upload one to establish your verified digital identity!
                    </p>
                    {% endif %}
                </div>

                <!-- Live Preview Section (hidden until file selected) -->
                <div id="preview-section" class="mb-4" style="display: none;">
                    <p class="small fw-semibold mb-2" style="color: #195de6;">
                        <i class="bi bi-crop me-1"></i> Position your photo â€” drag to adjust
                    </p>
                    <div id="crop-container" style="
                        width: 200px; height: 200px;
                        border-radius: 50%;
                        overflow: hidden;
                        margin: 0 auto;
                        border: 3px solid #195de6;
                        box-shadow: 0 4px 20px rgba(25, 93, 230, 0.25);
                        position: relative;
                        cursor: grab;
                        background-color: #f0f4ff;
                        touch-action: none;
                    ">
                        <!-- Grid overlay -->
                        <div id="grid-overlay" style="
                            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                            z-index: 2; pointer-events: none;
                            background:
                                linear-gradient(rgba(25,93,230,0.15) 1px, transparent 1px),
                                linear-gradient(90deg, rgba(25,93,230,0.15) 1px, transparent 1px);
                            background-size: 33.33% 33.33%;
                            opacity: 0;
                            transition: opacity 0.2s ease;
                        "></div>
                        <img id="preview-img" src="" alt="Preview" style="
                            position: absolute;
                            min-width: 100%; min-height: 100%;
                            user-select: none;
                            -webkit-user-drag: none;
                        ">
                    </div>
                    <!-- Zoom slider -->
                    <div class="d-flex align-items-center justify-content-center gap-2 mt-3"
                        style="max-width: 250px; margin: 0 auto;">
                        <i class="bi bi-zoom-out" style="color: var(--bs-secondary-color);"></i>
                        <input type="range" class="form-range" id="zoom-slider" min="100" max="300" value="100"
                            style="accent-color: #195de6;">
                        <i class="bi bi-zoom-in" style="color: var(--bs-secondary-color);"></i>
                    </div>
                    <p class="mt-2 small" style="color: var(--bs-secondary-color);">
                        Use the slider to zoom, then drag the image to position it.
                    </p>
                </div>

                <form action="/profile" method="POST" enctype="multipart/form-data">
                    <div class="mb-4 text-start">
                        <label for="avatar" class="form-label fw-bold">Upload your Immutable Profile Picture</label>
                        <input class="form-control bg-light" type="file" id="avatar" name="avatar" accept="image/*"
                            required>
                        <div class="form-text mt-2 fw-semibold" style="color: var(--bs-secondary-color);">
                            <i class="bi bi-shield-lock-fill" style="color: #195de6;"></i> Security
                            Lockout Policy: To prevent identity fraud, you may only alter your immutable profile image
                            once every 60 days.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill fw-bold shadow-sm"
                        style="background-color: #195de6; border: none;">
                        <i class="bi bi-cloud-arrow-up-fill me-1"></i> Register Digital Identity
                    </button>
                    <a href="/dashboard" class="btn btn-outline-secondary w-100 rounded-pill fw-bold mt-3">
                        Return to Dashboard
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const fileInput = document.getElementById('avatar');
        const previewSection = document.getElementById('preview-section');
        const previewImg = document.getElementById('preview-img');
        const cropContainer = document.getElementById('crop-container');
        const gridOverlay = document.getElementById('grid-overlay');
        const zoomSlider = document.getElementById('zoom-slider');
        const currentPhotoSection = document.getElementById('current-photo-section');

        let isDragging = false;
        let startX, startY, imgX = 0, imgY = 0;
        let scale = 1;
        let naturalW, naturalH;

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (ev) {
                previewImg.src = ev.target.result;
                previewImg.onload = function () {
                    naturalW = previewImg.naturalWidth;
                    naturalH = previewImg.naturalHeight;

                    // Reset
                    scale = 1;
                    zoomSlider.value = 100;
                    imgX = 0;
                    imgY = 0;

                    fitImage();
                    previewSection.style.display = 'block';
                    currentPhotoSection.style.display = 'none';
                };
            };
            reader.readAsDataURL(file);
        });

        function fitImage() {
            const containerSize = 200;
            // Scale so that the smaller dimension fills container
            const fitScale = Math.max(containerSize / naturalW, containerSize / naturalH);
            const w = naturalW * fitScale * scale;
            const h = naturalH * fitScale * scale;

            previewImg.style.width = w + 'px';
            previewImg.style.height = h + 'px';

            // Clamp position
            const maxX = 0;
            const minX = containerSize - w;
            const maxY = 0;
            const minY = containerSize - h;

            imgX = Math.min(maxX, Math.max(minX, imgX));
            imgY = Math.min(maxY, Math.max(minY, imgY));

            previewImg.style.left = imgX + 'px';
            previewImg.style.top = imgY + 'px';
        }

        zoomSlider.addEventListener('input', function () {
            scale = this.value / 100;
            fitImage();
        });

        // Mouse events
        cropContainer.addEventListener('mousedown', function (e) {
            isDragging = true;
            startX = e.clientX - imgX;
            startY = e.clientY - imgY;
            cropContainer.style.cursor = 'grabbing';
            gridOverlay.style.opacity = '1';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isDragging) return;
            imgX = e.clientX - startX;
            imgY = e.clientY - startY;
            fitImage();
        });

        document.addEventListener('mouseup', function () {
            if (isDragging) {
                isDragging = false;
                cropContainer.style.cursor = 'grab';
                gridOverlay.style.opacity = '0';
            }
        });

        // Touch events for mobile
        cropContainer.addEventListener('touchstart', function (e) {
            const touch = e.touches[0];
            isDragging = true;
            startX = touch.clientX - imgX;
            startY = touch.clientY - imgY;
            gridOverlay.style.opacity = '1';
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', function (e) {
            if (!isDragging) return;
            const touch = e.touches[0];
            imgX = touch.clientX - startX;
            imgY = touch.clientY - startY;
            fitImage();
        }, { passive: false });

        document.addEventListener('touchend', function () {
            if (isDragging) {
                isDragging = false;
                gridOverlay.style.opacity = '0';
            }
        });
    })();
</script>
{% endblock %}