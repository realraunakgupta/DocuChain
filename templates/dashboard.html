{% extends 'base.html' %}
{% block content %}
<div class="container animate-fade-in-up">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <div>
            <h2 class="fw-bold mb-1">
                {% if role == 'Issuer' %}
                <i class="bi bi-building text-primary me-2"></i> Issuer Portal
                {% else %}
                <i class="bi bi-person-badge text-success me-2"></i> My Documents
                {% endif %}
            </h2>
            <p class="text-muted mb-0">Authenticated as: <strong>{{ username }}</strong> ({{ role }})</p>
        </div>

        {% if role == 'Issuer' %}
        <a href="/issue" class="btn btn-primary rounded-pill shadow-sm fw-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-plus-lg me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
            </svg> Issue New Document
        </a>
        {% else %}
        <a href="/verify" class="btn btn-success rounded-pill shadow-sm fw-bold me-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-shield-check me-1" viewBox="0 0 16 16">
                <path
                    d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.462.545 7.15 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z" />
                <path
                    d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z" />
            </svg> Verify New Document
        </a>
        <a href="/request_verification" class="btn btn-outline-primary rounded-pill shadow-sm fw-bold">
            <i class="bi bi-send-plus-fill me-1"></i> Request Issuance
        </a>
        {% endif %}
    </div>

    <!-- Stats Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-light rounded-4">
                <div class="card-body py-4 text-center">
                    <h1
                        class="display-4 fw-bold {% if role == 'Issuer' %}text-primary{% else %}text-success{% endif %} mb-0">
                        {{ my_documents|length }}</h1>
                    <p class="text-muted fw-bold text-uppercase small mb-0 mt-2">
                        {% if role == 'Issuer' %}Documents Issued
                        {% else %}Verified Documents
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card shadow-sm border-0 bg-white rounded-4 h-100">
                <div class="card-body p-4 d-flex align-items-center">
                    <div>
                        <h5 class="fw-bold mb-2">Cryptographic Integrity <span class="badge bg-success ms-2">100%
                                SECURE</span></h5>
                        <p class="text-muted mb-0">Your account is fully synchronized with the offline blockchain
                            ledger. {% if role == 'Issuer' %}All certificates issued by {{ username }} are
                            mathematically anchored.{% else %}All documents listed below are cryptographically verified
                            to belong to {{ username }}.{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Verification Inbox & Pending Requests -->
    {% if role == 'Issuer' and my_requests %}
    <h4 class="fw-bold mb-3 mt-5 border-bottom pb-2 text-warning">
        <i class="bi bi-inbox-fill me-2"></i> Verification Inbox ({{ my_requests|length }} Pending)
    </h4>
    <div class="row g-4 mb-5">
        {% for req in my_requests|reverse %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-warning rounded-4">
                <div class="card-header bg-warning bg-opacity-10 pt-3 pb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <span class="badge bg-warning text-dark">{{ req.document_type }}</span>
                    </div>
                    <h5 class="fw-bold mt-2 mb-1">{{ req.holder }}</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3"><i class="bi bi-file-earmark-text me-1"></i> Pending review for
                        official issuance.</p>
                    <div class="d-flex gap-2">
                        <div class="d-flex gap-1 w-100">
                            <a href="/static/uploads/{{ req.file_path }}" target="_blank"
                                class="btn btn-sm btn-outline-secondary w-100" title="View"><i
                                    class="bi bi-eye"></i></a>
                            <a href="/static/uploads/{{ req.file_path }}" download
                                class="btn btn-sm btn-outline-secondary w-100" title="Download"><i
                                    class="bi bi-download"></i></a>
                        </div>
                        <form action="/approve_request/{{ req.id }}" method="POST" class="w-100"><button type="submit"
                                class="btn btn-sm btn-success w-100">Approve</button></form>
                        <form action="/reject_request/{{ req.id }}" method="POST" class="w-100"><button type="submit"
                                class="btn btn-sm btn-danger w-100">Reject</button></form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif role == 'Holder' %}
    <h4 class="fw-bold mb-3 mt-5 border-bottom pb-2">
        <i class="bi bi-clock-history me-2"></i> Verification Requests
    </h4>
    {% if my_requests %}
    <div class="row g-4 mb-4">
        {% for req in my_requests|reverse %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0 rounded-4">
                <div class="card-header bg-light pt-3 pb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <span class="badge bg-secondary">{{ req.document_type }}</span>
                        <span
                            class="badge {% if req.status == 'Approved' %}bg-success{% elif req.status == 'Rejected' %}bg-danger{% else %}bg-warning text-dark{% endif %}">{{
                            req.status }}</span>
                    </div>
                    <h5 class="fw-bold mt-2 mb-1">Target: {{ req.target_issuer }}</h5>
                </div>
                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                    <a href="/static/uploads/{{ req.file_path }}" target="_blank" class="small text-decoration-none"><i
                            class="bi bi-eye me-1"></i> View Doc</a>
                    <a href="/static/uploads/{{ req.file_path }}" download
                        class="small text-decoration-none text-success"><i class="bi bi-download me-1"></i> Download</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 bg-light rounded-4 border border-dashed mb-4">
        <p class="text-muted mb-0">You haven't submitted any documents for verification yet.</p>
    </div>
    {% endif %}
    {% endif %}

    <!-- Document List -->
    <h4 class="fw-bold mb-3 mt-5 border-bottom pb-2">
        {% if role == 'Issuer' %}Latest Issuances
        {% else %}My Digital Wallet
        {% endif %}
    </h4>

    {% if my_documents %}
    <div class="row g-4">
        {% for doc in my_documents|reverse %}
        <div class="col-md-6 col-lg-4">
            <div class="interactive-card h-100">
                <div class="card h-100 shadow-sm border-0 rounded-4">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="badge bg-light text-dark border px-2 py-1">{{ doc.document_type }}</span>
                            <small class="text-muted fw-bold">Block #{{ doc.index }}</small>
                        </div>
                        <h5 class="fw-bold mt-3 mb-1">
                            {% if role == 'Issuer' %}{{ doc.student_name }}
                            {% else %}{{ doc.issuer }}
                            {% endif %}
                        </h5>
                        <p class="text-muted small mb-0">ID: <span class="font-monospace">{{ doc.cert_id }}</span></p>
                    </div>
                    <div class="card-body mt-2">
                        <div class="bg-light p-3 rounded-3 text-center mb-3">
                            <p class="mb-1 text-uppercase small fw-bold text-muted">Digital Signature</p>
                            <p class="font-monospace mb-0 text-success small text-truncate"
                                title="{{ doc.document_hash }}">
                                {{ doc.document_hash[:20] }}...{{ doc.document_hash[-10:] }}</p>
                        </div>
                        <div class="d-flex gap-2 mt-auto">
                            <a href="/view_file/{{ doc.document_hash }}" target="_blank"
                                class="btn btn-sm btn-outline-primary w-100"><i class="bi bi-eye me-1"></i> View</a>
                            <a href="/download_file/{{ doc.document_hash }}"
                                class="btn btn-sm btn-outline-success w-100"><i class="bi bi-download me-1"></i>
                                Save</a>
                        </div>
                        <a href="/document/{{ doc.document_hash }}"
                            class="btn btn-sm btn-outline-primary rounded-pill w-100 mt-2">View on Blockchain</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 bg-light rounded-4 border border-dashed mt-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="var(--bs-gray-400)"
            class="bi bi-folder-x mb-3" viewBox="0 0 16 16">
            <path
                d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181L15.546 8H14.54l.265-2.91A1 1 0 0 0 13.81 4H2.19a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91H9v1H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zm6.339-1.576A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z" />
            <path
                d="M11.854 10.146a.5.5 0 0 0-.708.708L12.293 12l-1.147 1.146a.5.5 0 0 0 .708.708L13 12.707l1.146 1.147a.5.5 0 0 0 .708-.708L13.707 12l1.147-1.146a.5.5 0 0 0-.708-.708L13 11.293l-1.146-1.147z" />
        </svg>
        <h5 class="fw-bold text-muted">No Documents Found</h5>
        <p class="text-muted mb-0">
            {% if role == 'Issuer' %}You haven't issued any documents yet. Click "Issue New Document" to start building
            your ledger.
            {% else %}No documents have been anchored to your name by any verified institution yet.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}